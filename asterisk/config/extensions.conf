[general]
static=yes
writeprotect=no

[globals]

; Multi-tenant IVR Entry Point
[from-external]
exten => _X.,1,NoOp(Incoming call from ${CALLERID(num)} to ${EXTEN})
 same => n,Set(DID=${EXTEN})
 same => n,Set(TENANT_ID=${ODBC_TENANT_BY_DID(${DID})})
 same => n,GotoIf($["${TENANT_ID}" = ""]?no-tenant,1)
 same => n,Set(CDR(tenant_id)=${TENANT_ID})
 same => n,Goto(tenant-${TENANT_ID},${EXTEN},1)

exten => no-tenant,1,NoOp(No tenant found for DID ${DID})
 same => n,Playback(ss-noservice)
 same => n,Hangup()

; Template for tenant contexts (created dynamically via ARI)
[tenant-template](!)
exten => _X.,1,NoOp(Tenant Call Handler)
 same => n,Set(CHANNEL(language)=en)
 same => n,Answer()
 same => n,Stasis(ivr-handler,${TENANT_ID},${DID})
 same => n,Hangup()

; Example tenant context (tenant_id = 1)
[tenant-1](tenant-template)

; Example tenant context (tenant_id = 2)
[tenant-2](tenant-template)

; Internal extensions for testing
[internal]
exten => 100,1,NoOp(Test Extension)
 same => n,Answer()
 same => n,Playback(hello-world)
 same => n,Hangup()

exten => 999,1,NoOp(Echo Test)
 same => n,Answer()
 same => n,Echo()
 same => n,Hangup()